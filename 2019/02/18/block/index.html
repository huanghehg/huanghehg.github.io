<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ios,block," />










<meta name="description" content="clangå·¥å…· blockåˆ†ç±» block ç»“æ„ blockè°ƒç”¨ blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“ å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“">
<meta name="keywords" content="ios,block">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥å­¦ä¹ block">
<meta property="og:url" content="huanghehg.github.io/2019/02/18/block/index.html">
<meta property="og:site_name" content="é»„æ²³çš„ä¸ªäººç©ºé—´">
<meta property="og:description" content="clangå·¥å…· blockåˆ†ç±» block ç»“æ„ blockè°ƒç”¨ blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“ å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“">
<meta property="og:image" content="/images/block/1.png">
<meta property="og:image" content="/images/block/2.png">
<meta property="og:image" content="/images/block/3.png">
<meta property="og:image" content="/images/block/4.png">
<meta property="og:image" content="/images/block/5.png">
<meta property="og:image" content="/images/block/6.png">
<meta property="og:image" content="/images/block/7.png">
<meta property="og:updated_time" content="2019-12-14T03:27:35.045Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ·±å…¥å­¦ä¹ block">
<meta name="twitter:description" content="clangå·¥å…· blockåˆ†ç±» block ç»“æ„ blockè°ƒç”¨ blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“ å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“">
<meta name="twitter:image" content="/images/block/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="huanghehg.github.io/2019/02/18/block/"/>





  <title>æ·±å…¥å­¦ä¹ block | é»„æ²³çš„ä¸ªäººç©ºé—´</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">é»„æ²³çš„ä¸ªäººç©ºé—´</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="huanghehg.github.io/2019/02/18/block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="huanghe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="é»„æ²³çš„ä¸ªäººç©ºé—´">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">æ·±å…¥å­¦ä¹ block</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-02-18T15:29:04+08:00">
                2019-02-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ios/" itemprop="url" rel="index">
                    <span itemprop="name">ios</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <ul>
<li>clangå·¥å…·</li>
<li><code>block</code>åˆ†ç±»</li>
<li>block ç»“æ„</li>
<li>blockè°ƒç”¨</li>
<li>blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“</li>
<li>å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“</li>
</ul>
<a id="more"></a>
<hr>
<p>å‚è€ƒæ–‡ç« ï¼š<br><a href="https://www.jianshu.com/p/51d04b7639f1" target="_blank" rel="external">BlockæŠ€å·§ä¸åº•å±‚è§£æ</a><br><a href="https://www.jianshu.com/p/c50010380a86" target="_blank" rel="external">Blockåº•å±‚å®ç°åˆ†æ</a><br><a href="https://www.jianshu.com/p/da96ec752aee" target="_blank" rel="external">iOS Blockåº•å±‚æ¢ç´¢</a><br><a href="http://clang.llvm.org/docs/Block-ABI-Apple.html#high-level" target="_blank" rel="external">Block-ABI-Apple</a></p>
<hr>
<h3 id="clangå·¥å…·"><a href="#clangå·¥å…·" class="headerlink" title="clangå·¥å…·"></a>clangå·¥å…·</h3><p><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-clang/index.html" target="_blank" rel="external">clang</a>ç»“æ„åŒ–ç¼–è¯‘å™¨å‰ç«¯ï¼Œç®€å•ç†è§£ä¸ºå¯ä»¥ç¼–è¯‘<code>llvm</code>æ¶æ„çš„ä»£ç å·¥å…·</p>
<blockquote>
<p>Clang å¯¹æºç¨‹åºè¿›è¡Œè¯æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æï¼Œå¹¶å°†åˆ†æç»“æœè½¬æ¢ä¸º Abstract Syntax Tree ( æŠ½è±¡è¯­æ³•æ ‘ ) ï¼Œæœ€åä½¿ç”¨ LLVM ä½œä¸ºåç«¯ä»£ç çš„ç”Ÿæˆå™¨ã€‚</p>
</blockquote>
<p>ä½¿ç”¨æ–¹æ³•:<br><code>clang -rewrite-objc æ–‡ä»¶å</code></p>
<p>æ–°å»ºä¸€ä¸ªå·¥ç¨‹ï¼Œæ‰§è¡Œ<code>clang -rewrite-objc main.c</code>ä¼šç”Ÿæˆä¸€ä¸ª<code>main.cpp</code>æ–‡ä»¶</p>
<p><img src="/images/block/1.png" alt=""></p>
<hr>
<h3 id="block-ç»“æ„"><a href="#block-ç»“æ„" class="headerlink" title="block ç»“æ„"></a>block ç»“æ„</h3><p>å…ˆçœ‹ä¸€ä¸ªç®€å•çš„<code>block</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    ^&#123;</div><div class="line">        printf(&quot;hello world&quot;);</div><div class="line">    &#125;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>clang</code> ä¹‹åçœ‹ä¸€ä¸‹<code>main.cpp</code>, æŠŠå¤šä½™ä»£ç åˆ æ‰ä¸»è¦çœ‹ä»¥ä¸‹ä»£ç :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">struct __block_impl &#123;</div><div class="line">  void *isa;</div><div class="line">  int Flags;</div><div class="line">  int Reserved;</div><div class="line">  void *FuncPtr;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __main_block_desc_0* Desc;</div><div class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">//å®šä¹‰__main_block_desc_0ç»“æ„ä½“æ—¶ï¼ŒåŒæ—¶åˆ›å»ºäº†__main_block_desc_0_DATA å¹¶ç»™å®ƒèµ‹å€¼ï¼Œä»¥ä¾›åœ¨mainå‡½æ•°ä¸­å¯¹__main_block_impl_0è¿›è¡Œåˆå§‹åŒ–</div><div class="line">static struct __main_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</div><div class="line"></div><div class="line">//å¯¹åº”æºä»£ç ä¸­blockå†…éƒ¨ä»£ç </div><div class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line"></div><div class="line">        printf(&quot;hello world&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å¯¹åº”æºä»£ç çš„mainå‡½æ•°</div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA))();</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡å¯¹æ¯”å¯ä»¥çœ‹åˆ°ï¼Œ<code>block</code>å¯¹åº”<code>struct __main_block_impl_0</code> è¿™ä¸ªç»“æ„ä½“ï¼Œæ„æ€å°±æ˜¯<code>main</code>å‡½æ•°ä¸­ç¬¬<code>0</code>ä¸ª<code>block</code>å®ç°ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«</p>
<ul>
<li><code>struct __block_impl impl</code><ul>
<li><code>void *isa</code>    <ul>
<li>æŒ‡å‘å¯¹åº”ç±»å‹çš„æŒ‡é’ˆ</li>
</ul>
</li>
<li><code>int Flags</code> <ul>
<li>æ ‡å¿—å˜é‡ï¼Œåœ¨å®ç°blockçš„å†…éƒ¨æ“ä½œæ—¶ä¼šç”¨åˆ°</li>
</ul>
</li>
<li><code>int Reserved</code> <ul>
<li>ä¿ç•™å­—æ®µ</li>
</ul>
</li>
<li><code>void *FuncPtr</code><ul>
<li><code>block</code>æ‰§è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°çš„æŒ‡é’ˆ</li>
</ul>
</li>
</ul>
</li>
<li><code>struct __main_block_desc_0</code><ul>
<li><code>size_t reserved</code> <ul>
<li>ä¿ç•™å­—æ®µ</li>
</ul>
</li>
<li><code>size_t Block_size</code><ul>
<li><code>block</code>å¤§å°</li>
</ul>
</li>
</ul>
</li>
<li><code>__main_block_impl_0</code><ul>
<li>æ˜¾å¼çš„æ„é€ å‡½æ•°</li>
</ul>
</li>
</ul>
<p><em>è¿™é‡Œæœ‰ä¸€ä¸ªçº ç»“çš„åœ°æ–¹<code>block</code>åˆ°åº•æ˜¯<code>__main_block_impl_0</code> è¿˜æ˜¯<code>__block_impl</code>ï¼Œç›®å‰ç†è§£ä¸º<code>__block_impl</code>ä¸ºç³»ç»Ÿå®šä¹‰<code>block</code>çš„å®ç°ï¼Œ<code>__main_block_impl_0</code>æ˜¯å®é™…<code>block</code>å®ç°ï¼Œç›¸å½“äºåœ¨<code>block</code>æœ¬è´¨å®ç°çš„åŸºç¡€ä¸Šæ–°å¢äº†ç‰¹æ€§ã€‚</em></p>
<p>å¯¹æ¯”å®˜æ–¹å®šä¹‰çš„<a href="https://llvm.org/svn/llvm-project/compiler-rt/trunk/lib/BlocksRuntime/Block_private.h" target="_blank" rel="external">block</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/* Revised new layout. */</div><div class="line">struct Block_descriptor &#123;</div><div class="line">    unsigned long int reserved;</div><div class="line">    unsigned long int size;</div><div class="line">    void (*copy)(void *dst, void *src);</div><div class="line">    void (*dispose)(void *);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">struct Block_layout &#123;</div><div class="line">    void *isa;</div><div class="line">    int flags;</div><div class="line">    int reserved; </div><div class="line">    void (*invoke)(void *, ...);</div><div class="line">    struct Block_descriptor *descriptor;</div><div class="line">    /* Imported variables. */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>invoke</code>å’Œ<code>FuncPtr</code>æ˜¯ä¸€æ ·çš„åªæ˜¯<code>clang</code>ç”Ÿæˆçš„å˜é‡åä¸åŒï¼Œ<code>copy</code>å’Œ<code>dispose</code>æ—¶æ•è·å¤–éƒ¨å˜é‡æ—¶ä½¿ç”¨ï¼Œåœ¨ä¸‹é¢ä¼šè®¨è®ºã€‚</p>
<p>æ‰€ä»¥å¾—å‡ºä¸€ä¸ªç»“è®º<code>block</code>æ˜¯ä¸€ä¸ªåŒ…å«<strong>è°ƒç”¨å‡½æ•°æŒ‡é’ˆ</strong>ã€<strong>blockå¤–éƒ¨ä¸Šä¸‹æ–‡å˜é‡</strong>çš„ç»“æ„ä½“ï¼Œå…¶æ¬¡å†…éƒ¨åŒ…å«<code>isa</code>æŒ‡é’ˆï¼Œè¯´æ˜<strong><code>block</code>ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡</strong></p>
<hr>
<h3 id="blockè°ƒç”¨"><a href="#blockè°ƒç”¨" class="headerlink" title="blockè°ƒç”¨"></a><code>block</code>è°ƒç”¨</h3><p>åˆ›å»ºç®€å•<code>block</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> void(^testblock)() =^&#123;</div><div class="line">        printf(&quot;hello world&quot;);</div><div class="line">&#125;;</div><div class="line">testblock();</div></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œ<code>clang</code>ï¼Œå…¶ä»–ç”Ÿæˆä»£ç éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€è‡´ä¸»è¦çœ‹<code>main</code>å‡½æ•°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">struct __main_block_impl_2 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __main_block_desc_2* Desc;</div><div class="line">  __main_block_impl_2(void *fp, struct __main_block_desc_2 *desc, int flags=0) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">void(*testblock)() =((void (*)())&amp;__main_block_impl_2((void *)__main_block_func_2, &amp;__main_block_desc_2_DATA));</div><div class="line">    ((void (*)(__block_impl *))((__block_impl *)testblock)-&gt;FuncPtr)((__block_impl *)testblock);</div></pre></td></tr></table></figure></p>
<ol>
<li>è°ƒç”¨<code>__main_block_impl_2</code>æ˜¾å¼æ„é€ å‡½æ•°</li>
<li><code>&amp;</code>å°†1ç»“æœåœ°å€èµ‹å€¼ç»™<code>testblock</code></li>
<li>å°†<code>testblock</code>å¼ºè½¬æˆ<code>__block_impl</code>è°ƒç”¨<code>FuncPtr</code>ä¹Ÿå°±æ˜¯<code>__main_block_func_2</code></li>
</ol>
<p><strong>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç†è®ºä¸Š<code>testblock</code>çš„ç±»å‹æ˜¯<code>__main_block_impl_2</code>ä¸ºä»€ä¹ˆå¯ä»¥å¼ºè½¬æˆ<code>__block_impl</code>?</strong></p>
<p><strong>è¿™æ˜¯å› ä¸º<code>&amp;</code>å–å¾—æ˜¯èµ·å§‹åœ°å€ï¼Œç»“æ„ä½“çš„èµ·å§‹åœ°å€å’Œä»–ç¬¬ä¸€ä¸ªå…ƒç´ çš„èµ·å§‹åœ°å€æ˜¯ä¸€è‡´çš„ä¹Ÿå°±æ˜¯è¯´<code>&amp;__main_block_impl_2</code> å’Œ <code>&amp;(__main_block_impl_2-&gt;__block_impl)</code>åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å¼ºåˆ¶è½¬åŒ–</strong></p>
<hr>
<h3 id="blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“"><a href="#blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“" class="headerlink" title="blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“"></a><code>block</code>ç±»å‹ä»¥åŠ<code>ARC</code>å¯¹<code>block</code>çš„å½±å“</h3><p><code>block</code>çš„å¸¸è§ç±»å‹æœ‰3ç§ï¼š</p>
<ul>
<li><code>NSConcreteStackBlock</code>ï¼ˆæ ˆï¼‰</li>
<li><code>NSConcreteGlobalBlock</code>ï¼ˆå…¨å±€ï¼‰</li>
<li><code>NSConcreteMallocBlock</code>ï¼ˆå †ï¼‰</li>
</ul>
<p>æˆ‘ä»¬å…ˆç®€å•åˆ›å»ºä¸¤ä¸ª<code>block</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#import &quot;TestBlock.h&quot;</div><div class="line"></div><div class="line">void (^globalBlock)(void) = ^&#123;</div><div class="line">    </div><div class="line">&#125;;</div><div class="line"></div><div class="line">@implementation TestBlock</div><div class="line"></div><div class="line">- (void)testStackBlock&#123;</div><div class="line">    void(^stackBlock)(void) = ^&#123;</div><div class="line">        NSLog(@&quot;stackBlock&quot;);</div><div class="line">    &#125;;</div><div class="line">    stackBlock();</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>å¯¹å…¶è¿›è¡Œç¼–è¯‘è½¬æ¢åå¾—åˆ°ä»¥ä¸‹ç¼©ç•¥ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">struct __globalBlock_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __globalBlock_block_desc_0* Desc;</div><div class="line">  __globalBlock_block_impl_0(void *fp, struct __globalBlock_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteGlobalBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">...</div><div class="line">struct __TestBlock__testStackBlock_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_0* Desc;</div><div class="line">  __TestBlock__testStackBlock_block_impl_0(void *fp, struct __TestBlock__testStackBlock_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>è§‚å¯Ÿä¸€ä¸‹ä¸Šé¢ç®€å•<code>block</code>å‘ç°<strong><code>impl.isa</code></strong>ä¾¿æ˜¯å¯¹åº”çš„<code>block</code>ç±»å‹;å¯ä»¥çœ‹åˆ°<code>globalBlock</code>å±äº<code>NSConcreteGlobalBlock</code>ï¼Œ<code>stackBlock</code>å±äº<code>NSConcreteStackBlock</code>ã€‚<br>ç„¶è€Œæˆ‘ä»¬å®é™…è¾“å‡ºï¼š</p>
<p><img src="/images/block/2.png" alt=""></p>
<p><strong><code>stackblock</code>ä¹Ÿå±äº<code>globalBlock</code>ï¼Œ<code>why</code></strong>ï¼Ÿï¼Ÿï¼Ÿ<br><a href="https://blog.devtang.com/2013/07/28/a-look-inside-blocks/" target="_blank" rel="external">å‚ç…§å”å·§åšå®¢è§£é‡Š</a></p>
<blockquote>
<p>ç”±äº clang æ”¹å†™çš„å…·ä½“å®ç°æ–¹å¼å’Œ LLVM ä¸å¤ªä¸€æ ·ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰å¼€å¯ ARCã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬çœ‹åˆ° isa æŒ‡å‘çš„è¿˜æ˜¯_NSConcreteStackBlockã€‚ä½†åœ¨ LLVM çš„å®ç°ä¸­ï¼Œå¼€å¯ ARC æ—¶ï¼Œblock åº”è¯¥æ˜¯ _NSConcreteGlobalBlock ç±»å‹</p>
</blockquote>
<p>è¯¦ç»†çš„<code>LLVM</code>è§£æçœ‹<a href="http://clang.llvm.org/docs/Block-ABI-Apple.html" target="_blank" rel="external">llvmå¯¹äºBlockçš„ç¼–è¯‘è§„åˆ™</a>ï¼ˆæˆ‘æ²¡å…¨éƒ¨çœ‹å®ŒğŸ˜…ï¼‰ã€‚</p>
<p>å¯ä»¥ç†è§£ä¸ºç”±äºblockä¸­çš„ä»£ç æ²¡æœ‰æ•è·ä»»ä½•å¤–éƒ¨å˜é‡ï¼Œè¿™ä¸ª<code>block</code>ä¸å­˜åœ¨ä»»ä½•å†…å­˜æ³„æ¼çš„é£é™©ï¼Œä¹Ÿä¸éœ€è¦å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥ç±»å‹ä¸º<code>__NSGlobalBlock__</code>ã€‚</p>
<p>æ‰€ä»¥å¦‚æœ<code>block</code>å†…éƒ¨å¼•ç”¨äº†å¤–éƒ¨å˜é‡å°±ä¸ä¼šå˜æˆ<code>__NSGlobalBlock__</code>ï¼Œæ–°å¢ä»¥ä¸‹ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (void)testStackBlock &#123;</div><div class="line">		...</div><div class="line">		int a = 0;</div><div class="line">    	void(^blockWithVar)(void) = ^&#123;</div><div class="line">     	   NSLog(@&quot;%d&quot;, a);</div><div class="line">	  	&#125;;</div><div class="line">	  	</div><div class="line">		blockWithVar();</div><div class="line">		...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>clang ä¹‹åï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct __TestBlock__testStackBlock_block_impl_2 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_2* Desc;</div><div class="line">  int a;</div><div class="line">  __TestBlock__testStackBlock_block_impl_2(void *fp, struct __TestBlock__testStackBlock_block_desc_2 *desc, int _a, int flags=0) : a(_a) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>å‘ç°<code>impl.isa</code>æŒ‡å‘<code>NSConcreteStackBlock</code>ï¼Œç„¶è€Œæˆ‘ä»¬è¾“å‡ºå‘ç°ï¼š</p>
<p><img src="/images/block/3.png" alt=""></p>
<p>åˆ›å»º<code>block</code>æ—¶æ˜¯åœ¨<code>__NSStackBlock__</code>ï¼Œè€Œèµ‹å€¼ç»™<code>blockWithVar</code>åï¼Œ<code>blockWithVar</code>å±äº<code>__NSMallocBlock__</code>ï¼Œè¿™æ˜¯å› ä¸º<code>ARC</code>ç¯å¢ƒä¸‹</p>
<blockquote>
<p>åœ¨ ARC ä¸‹ï¼Œblock ç±»å‹é€šè¿‡=è¿›è¡Œä¼ é€’æ—¶ï¼Œä¼šå¯¼è‡´è°ƒç”¨objc_retainBlock-&gt;_Block_copy-&gt;_Block_copy_internalæ–¹æ³•é“¾ã€‚å¹¶å¯¼è‡´ <strong>NSStackBlock</strong> ç±»å‹çš„ block è½¬æ¢ä¸º <strong>NSMallocBlock</strong> ç±»å‹ã€‚<br>åŸæ–‡åœ°å€ï¼š<a href="https://www.jianshu.com/p/0855b68d1c1d" target="_blank" rel="external">https://www.jianshu.com/p/0855b68d1c1d</a></p>
</blockquote>
<p><a href="https://opensource.apple.com/source/objc4/objc4-532/runtime/NSObject.mm.auto.html" target="_blank" rel="external">NSObject.mm</a>æºä»£ç å¯ä»¥çœ‹åˆ°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">// The -fobjc-arc flag causes the compiler to issue calls to objc_&#123;retain/release/autorelease/retain_block&#125;</div><div class="line">//</div><div class="line"></div><div class="line">id objc_retainBlock(id x) &#123;</div><div class="line">#if ARR_LOGGING</div><div class="line">    objc_arr_log(&quot;objc_retain_block&quot;, x);</div><div class="line">    ++CompilerGenerated.blockCopies;</div><div class="line">#endif</div><div class="line">    return (id)_Block_copy(x);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>_Block_copy</code>æ˜¯åœ¨<a href="https://opensource.apple.com/source/clang/clang-137/src/projects/compiler-rt/BlocksRuntime/runtime.c" target="_blank" rel="external">runtime.c</a>ä¸­å®ç°çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">void *_Block_copy(const void *arg) &#123;</div><div class="line">    return _Block_copy_internal(arg, WANTS_ONE);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">#if 0</div><div class="line">#pragma mark Copy/Release support</div><div class="line">#endif /* if 0 */</div><div class="line"></div><div class="line">/* Copy, or bump refcount, of a block.  If really copying, call the copy helper if present. */</div><div class="line">static void *_Block_copy_internal(const void *arg, const int flags) &#123;</div><div class="line">    struct Block_layout *aBlock;</div><div class="line">    const bool wantsOne = (WANTS_ONE &amp; flags) == WANTS_ONE;</div><div class="line"></div><div class="line">    //printf(&quot;_Block_copy_internal(%p, %x)\n&quot;, arg, flags);	</div><div class="line">    if (!arg) return NULL;</div><div class="line">    </div><div class="line">    </div><div class="line">    // The following would be better done as a switch statement</div><div class="line">    aBlock = (struct Block_layout *)arg;</div><div class="line">    </div><div class="line">		//    å †blockå¼•ç”¨è®¡æ•°åŠ 1</div><div class="line">    if (aBlock-&gt;flags &amp; BLOCK_NEEDS_FREE) &#123;</div><div class="line">        // latches on high</div><div class="line">        latching_incr_int(&amp;aBlock-&gt;flags);</div><div class="line">        return aBlock;</div><div class="line">    &#125;</div><div class="line">    else if (aBlock-&gt;flags &amp; BLOCK_IS_GC) &#123;</div><div class="line">        // GC refcounting is expensive so do most refcounting here.</div><div class="line">        if (wantsOne &amp;&amp; ((latching_incr_int(&amp;aBlock-&gt;flags) &amp; BLOCK_REFCOUNT_MASK) == 1)) &#123;</div><div class="line">            // Tell collector to hang on this - it will bump the GC refcount version</div><div class="line">            _Block_setHasRefcount(aBlock, true);</div><div class="line">        &#125;</div><div class="line">        return aBlock;</div><div class="line">    &#125;</div><div class="line">    //å…¨å±€ç±»å‹ç›´æ¥è¿”å›</div><div class="line">    else if (aBlock-&gt;flags &amp; BLOCK_IS_GLOBAL) &#123;</div><div class="line">        return aBlock;</div><div class="line">    &#125;</div><div class="line">------------------------------------------------------------</div><div class="line">    // Its a stack block.  Make a copy.</div><div class="line">------------------------------------------------------------</div><div class="line">    if (!isGC) &#123;</div><div class="line">        struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);</div><div class="line">        if (!result) return (void *)0;</div><div class="line">        memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first</div><div class="line">        // reset refcount</div><div class="line">        result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed</div><div class="line">        // æ·»åŠ éœ€è¦é‡Šæ”¾çš„flag</div><div class="line">        result-&gt;flags |= BLOCK_NEEDS_FREE | 1;</div><div class="line">        result-&gt;isa = _NSConcreteMallocBlock;</div><div class="line">        if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) &#123;</div><div class="line">            //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&gt;descriptor-&gt;copy, result, aBlock);</div><div class="line">            (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…³é—­<code>ARC</code>æµ‹è¯•ä¸‹:</p>
<p><img src="/images/block/4.png" alt=""></p>
<p>æ­¤æ—¶è¾“å‡º<code>blockWithVar</code>æ˜¯å±äº<code>__NSStackBlock__</code></p>
<p><img src="/images/block/5.png" alt=""></p>
<p>æˆ‘ä»¬æ‰“å¼€<code>ARC</code>ç»§ç»­çœ‹ï¼Œ<code>ARC</code>ç¯å¢ƒä¸‹æ‰€æœ‰çš„<code>block</code>èµ‹å€¼ç»™å˜é‡éƒ½ä¼š<code>copy</code>åˆ°å †ä¸Šå—ï¼Ÿ</p>
<p><img src="/images/block/6.png" alt=""></p>
<p>å‘ç°ä½¿ç”¨<code>__weak</code>ä¿®é¥°æ—¶å¹¶ä¸ä¼šå¤åˆ¶åˆ°å †ä¸Šã€‚æ‰€ä»¥å¦‚æœä½¿ç”¨è¦æ³¨æ„ï¼ï¼ï¼</p>
<p><strong>ARCå¯¹ç±»å‹ä¸ºstrongä¸”æ•è·äº†å¤–éƒ¨å˜é‡çš„blockè¿›è¡Œäº†copyã€‚å¹¶ä¸”å½“blockç±»å‹ä¸ºstrongï¼Œä½†æ˜¯åˆ›å»ºæ—¶æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œblockæœ€ç»ˆä¼šå˜æˆ<strong>NSGlobalBlock</strong>ç±»å‹</strong></p>
<h3 id="å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“"><a href="#å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“" class="headerlink" title="å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“"></a>å¤–éƒ¨å˜é‡å¯¹<code>block</code>çš„å½±å“</h3><p><strong>æ•æ‰å±€éƒ¨å˜é‡çš„å½±å“</strong></p>
<p>é¦–å…ˆçœ‹ä¸‹é¢çš„ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">int a = 1;</div><div class="line">    </div><div class="line">void(^blockWithVar)(void) = ^&#123;</div><div class="line">   NSLog(@&quot;%d&quot;, a);</div><div class="line">&#125;;</div><div class="line">    </div><div class="line">void(^blockWithNonVar)(void) = ^&#123;</div><div class="line">   NSLog(@&quot;test&quot;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>è½¬åŒ–å</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">struct __TestBlock__testStackBlock_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_0* Desc;</div><div class="line">  int a;</div><div class="line">  __TestBlock__testStackBlock_block_impl_0(void *fp, struct __TestBlock__testStackBlock_block_desc_0 *desc, int _a, int flags=0) : a(_a) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __TestBlock__testStackBlock_block_func_0(struct __TestBlock__testStackBlock_block_impl_0 *__cself) &#123;</div><div class="line">  int a = __cself-&gt;a; // bound by copy</div><div class="line"></div><div class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_91f955_mi_0, a);</div><div class="line">    &#125;</div><div class="line">...</div><div class="line"></div><div class="line">struct __TestBlock__testStackBlock_block_impl_1 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_1* Desc;</div><div class="line">  __TestBlock__testStackBlock_block_impl_1(void *fp, struct __TestBlock__testStackBlock_block_desc_1 *desc, int flags=0) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __TestBlock__testStackBlock_block_func_1(struct __TestBlock__testStackBlock_block_impl_1 *__cself) &#123;</div><div class="line"></div><div class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_91f955_mi_1);</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">static void _I_TestBlock_testStackBlock(TestBlock * self, SEL _cmd) &#123;</div><div class="line">    int a = 1;</div><div class="line"></div><div class="line">    void(*blockWithVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_0((void *)__TestBlock__testStackBlock_block_func_0, &amp;__TestBlock__testStackBlock_block_desc_0_DATA, a));</div><div class="line"></div><div class="line">    void(*blockWithNonVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_1((void *)__TestBlock__testStackBlock_block_func_1, &amp;__TestBlock__testStackBlock_block_desc_1_DATA));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹æ¯”å‘ç°<code>blockWithVar</code>åœ¨è½¬åŒ–åå¤šäº†ä¸€ä¸ª<code>int a</code>çš„å˜é‡ï¼ŒåŒæ—¶åœ¨æ˜¾å¼æ„é€ å‡½æ•°é‡Œå¤šäº†<code>int _a</code>ï¼Œåé¢çš„<code>: a(_a)</code>ç›¸å½“äº<code>a = _a</code>ï¼Œæ˜¯<code>c++</code>ä¸­çš„<a href="https://stackoverflow.com/questions/2785612/c-what-does-the-colon-after-a-constructor-mean" target="_blank" rel="external">åˆå§‹åŒ–åˆ—è¡¨</a>ã€‚é€šè¿‡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static void _I_TestBlock_testStackBlock(TestBlock * self, SEL _cmd) &#123;</div><div class="line">	int a = 1;</div><div class="line">	void(*blockWithVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_0((void *)__TestBlock__testStackBlock_block_func_0, &amp;__TestBlock__testStackBlock_block_desc_0_DATA, a));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">static void __TestBlock__testStackBlock_block_func_0(struct __TestBlock__testStackBlock_block_impl_0 *__cself) &#123;</div><div class="line">  int a = __cself-&gt;a; // bound by copy</div><div class="line"></div><div class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_91f955_mi_0, a);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å‘ç°<code>a</code>ä¼ é€’åˆ°<code>block</code>ä¸­æ˜¯å€¼ä¼ é€’ï¼Œåœ¨è°ƒç”¨é‡Œä¼šç”Ÿæˆå¦å¤–ä¸€ä¸ª<code>a</code>(<code>int a = __cself-&gt;a;</code>) æ‰€ä»¥æˆ‘ä»¬åœ¨<code>block</code>ä¸­æ›´æ”¹<code>a</code>çš„å€¼æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚åŒæ—¶ç¼–è¯‘å™¨ä¹Ÿä¼šæŠ¥é”™</p>
<p><img src="/images/block/7.png" alt=""></p>
<p>çœ‹æŠ¥é”™æç¤ºåŠ ä¸Š<code>__block</code>ï¼Œé‚£æˆ‘ä»¬åŠ ä¸Š<code>__block</code>çœ‹ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (void)testStackBlock&#123;</div><div class="line">    __block int a = 1;</div><div class="line">    void(^blockWithVar)(void) = ^&#123;</div><div class="line">        NSLog(@&quot;pre =&gt; %d&quot;, a);</div><div class="line">        a = 3;</div><div class="line">    &#125;;</div><div class="line">    blockWithVar();</div><div class="line">    NSLog(@&quot;res =&gt; %d&quot;, a);</div><div class="line">    void(^blockWithNonVar)(void) = ^&#123;</div><div class="line">        NSLog(@&quot;test&quot;);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è½¬åŒ–åå…³é”®ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">struct __Block_byref_a_0 &#123;</div><div class="line">  void *__isa;</div><div class="line">__Block_byref_a_0 *__forwarding;</div><div class="line"> int __flags;</div><div class="line"> int __size;</div><div class="line"> int a;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct __TestBlock__testStackBlock_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_0* Desc;</div><div class="line">  __Block_byref_a_0 *a; // by ref</div><div class="line">  __TestBlock__testStackBlock_block_impl_0(void *fp, struct __TestBlock__testStackBlock_block_desc_0 *desc, __Block_byref_a_0 *_a, int flags=0) : a(_a-&gt;__forwarding) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __TestBlock__testStackBlock_block_func_0(struct __TestBlock__testStackBlock_block_impl_0 *__cself) &#123;</div><div class="line">  __Block_byref_a_0 *a = __cself-&gt;a; // bound by ref</div><div class="line"></div><div class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_63aeec_mi_0, (a-&gt;__forwarding-&gt;a));</div><div class="line">        (a-&gt;__forwarding-&gt;a) = 3;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">// è¾…åŠ©copyå‡½æ•°ï¼Œä¸‹é¢ä¼šç”¨åˆ°</div><div class="line">static void __TestBlock__testStackBlock_block_copy_0(struct __TestBlock__testStackBlock_block_impl_0*dst, struct __TestBlock__testStackBlock_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">// è¾…åŠ©disposeå‡½æ•°ï¼Œä¸‹é¢ä¼šç”¨åˆ°</div><div class="line">static void __TestBlock__testStackBlock_block_dispose_0(struct __TestBlock__testStackBlock_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">static struct __TestBlock__testStackBlock_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">  void (*copy)(struct __TestBlock__testStackBlock_block_impl_0*, struct __TestBlock__testStackBlock_block_impl_0*);</div><div class="line">  void (*dispose)(struct __TestBlock__testStackBlock_block_impl_0*);</div><div class="line">&#125; __TestBlock__testStackBlock_block_desc_0_DATA = &#123; 0, sizeof(struct __TestBlock__testStackBlock_block_impl_0), __TestBlock__testStackBlock_block_copy_0, __TestBlock__testStackBlock_block_dispose_0&#125;;</div><div class="line"></div><div class="line"></div><div class="line">// å¯¹åº”çš„æ˜¯testStackBlock</div><div class="line">static void _I_TestBlock_testStackBlock(TestBlock * self, SEL _cmd) &#123;</div><div class="line"></div><div class="line">    __attribute__((__blocks__(byref))) __Block_byref_a_0 a = &#123;(void*)0,(__Block_byref_a_0 *)&amp;a, 0, sizeof(__Block_byref_a_0), 1&#125;;</div><div class="line">    void(*blockWithVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_0((void *)__TestBlock__testStackBlock_block_func_0, &amp;__TestBlock__testStackBlock_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, 570425344));</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>å…ˆçœ‹æœ€åçš„<code>_I_TestBlock_testStackBlock</code>,å‘ç°åŠ ä¸Š<code>__block</code>å…³é”®å­—ä¹‹å<code>a</code>å·²ç»ä¸æ˜¯<code>int</code>ç±»å‹è€Œæ˜¯å¯¹åº”<code>__Block_byref_a_0</code>ç±»å‹</li>
<li>å†è§‚å¯Ÿ<code>__Block_byref_a_0</code>åŒ…å«:<ul>
<li><code>void *__isa</code> è¯´æ˜æ˜¯ä¸€ä¸ªå¯¹è±¡</li>
<li><code>__Block_byref_a_0 *__forwarding;</code></li>
<li><code>int __flags;</code></li>
<li><code>int __size;</code></li>
<li><code>int a;</code>è¿™é‡Œé¢çš„<code>a</code>å¯¹åº”çš„å°±æ˜¯<code>block</code>å¤–é¢èµ‹çš„å€¼</li>
</ul>
</li>
<li>ç»§ç»­è§‚å¯Ÿ<code>(__Block_byref_a_0 *)&amp;a</code>,åœ¨<code>block</code>ç¼–è¯‘æ—¶å°†<code>(__Block_byref_a_0 *)&amp;a</code>ä¼ ç»™äº†<code>block</code>,æ‰€ä»¥ä¸å†æ˜¯å€¼ä¼ é€’è€Œæ˜¯å†…å­˜åœ°å€ä¼ é€’ï¼Œæ‰€ä»¥åœ¨<code>block</code>å†…å¯ä»¥æ“çºµa</li>
</ol>
<p>é‚£ä¹ˆå¦‚æœç›´æ¥ä¼ é€’å†…å­˜åœ°å€è€Œä¸ä½¿ç”¨<code>__block</code>å¯ä»¥å—ï¼Ÿ<br>å°†ä»£ç ä¿®æ”¹å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (void)testStackBlock&#123;</div><div class="line">    int a = 1;</div><div class="line">    int *p = &amp;a;</div><div class="line">    void(^blockWithVar)(void) = ^&#123;</div><div class="line">        NSLog(@&quot;pre =&gt; %d&quot;, *p);</div><div class="line">        *p = 3;</div><div class="line">    &#125;;</div><div class="line">    blockWithVar();</div><div class="line">    NSLog(@&quot;res =&gt; %d&quot;, *p);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œå‘ç°å¯ä»¥ä¿®æ”¹ï¼Œä½†è¿™æ ·å¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºæ¥å¦‚æœ<code>a</code>é‡Šæ”¾äº†ï¼Œ<code>p</code>å°±å˜æˆäº†é‡æŒ‡é’ˆ,å¦‚æœblockæ˜¯ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼ï¼Œè¿™äº›ç±»å‹éƒ½æ˜¯è·¨æ ˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å†æ¬¡è°ƒç”¨ä¼šé€ æˆé‡æŒ‡é’ˆé”™è¯¯ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (void)testStackBlock&#123;</div><div class="line">    int a = 1;</div><div class="line">    int *p = &amp;a;</div><div class="line">    void(^blockWithVar)(void) = ^&#123;</div><div class="line">        NSLog(@&quot;pre =&gt; %d&quot;, *p);</div><div class="line">        *p = 3;</div><div class="line">    &#125;;</div><div class="line">//    blockWithVar();</div><div class="line">    NSLog(@&quot;res =&gt; %d&quot;, *p);</div><div class="line">    [self.blockArray addObject:blockWithVar];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)testBlock:(void(^)(void))block &#123;</div><div class="line">    block();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>æ•æ‰å±€éƒ¨é™æ€å˜é‡çš„å½±å“</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)testStackBlock&#123;</div><div class="line">    static int a = 1;</div><div class="line">    void(^blockWithVar)(void) = ^&#123;</div><div class="line">        a = 3;</div><div class="line">    &#125;;</div><div class="line">    NSLog(@&quot;pre a =&gt; %d&quot;, a);</div><div class="line">    blockWithVar();</div><div class="line">    NSLog(@&quot;res a =&gt; %d&quot;, a);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è½¬åŒ–å<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">struct __TestBlock__testStackBlock_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_0* Desc;</div><div class="line">  int *a;</div><div class="line">  __TestBlock__testStackBlock_block_impl_0(void *fp, struct __TestBlock__testStackBlock_block_desc_0 *desc, int *_a, int flags=0) : a(_a) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __TestBlock__testStackBlock_block_func_0(struct __TestBlock__testStackBlock_block_impl_0 *__cself) &#123;</div><div class="line">  int *a = __cself-&gt;a; // bound by copy</div><div class="line">		//åœ°å€è®¿é—®</div><div class="line">        (*a) = 3;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">static struct __TestBlock__testStackBlock_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">&#125; __TestBlock__testStackBlock_block_desc_0_DATA = &#123; 0, sizeof(struct __TestBlock__testStackBlock_block_impl_0)&#125;;</div><div class="line"></div><div class="line">static void _I_TestBlock_testStackBlock(TestBlock * self, SEL _cmd) &#123;</div><div class="line">    static int a = 1;</div><div class="line">    void(*blockWithVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_0((void *)__TestBlock__testStackBlock_block_func_0, &amp;__TestBlock__testStackBlock_block_desc_0_DATA, &amp;a));</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_188fa3_mi_0, a);</div><div class="line">    ((void (*)(__block_impl *))((__block_impl *)blockWithVar)-&gt;FuncPtr)((__block_impl *)blockWithVar);</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_188fa3_mi_1, a);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶<code>a</code>æ˜¯åœ°å€ä¼ é€’ï¼Œåœ¨blockå†…éƒ¨ä¹Ÿå¯ä»¥æˆåŠŸæ›´æ”¹<code>a</code>çš„å€¼ï¼Œ</p>
<blockquote>
<p>éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯é™æ€å±€éƒ¨å˜é‡æ˜¯å­˜å‚¨åœ¨é™æ€æ•°æ®å­˜å‚¨åŒºåŸŸçš„ï¼Œä¹Ÿå°±æ˜¯å’Œç¨‹åºæ‹¥æœ‰ä¸€æ ·çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œéƒ½èƒ½å¤Ÿä¿è¯blockè®¿é—®åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„å˜é‡ã€‚ä½†æ˜¯å…¶ä½œç”¨èŒƒå›´è¿˜æ˜¯å±€é™äºå®šä¹‰å®ƒçš„å‡½æ•°ä¸­ï¼Œæ‰€ä»¥åªèƒ½åœ¨blocké€šè¿‡é™æ€å±€éƒ¨å˜é‡çš„åœ°å€æ¥è¿›è¡Œè®¿é—®ã€‚</p>
</blockquote>
<p><strong>æ•æ‰å…¨å±€å˜é‡çš„å½±å“</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">int b = 3;</div><div class="line">static int c = 4;</div><div class="line">- (void)testStackBlock&#123;</div><div class="line">    void(^blockWithVar)(void) = ^&#123;</div><div class="line">        b = 5;</div><div class="line">        c = 6;</div><div class="line">    &#125;;</div><div class="line">    NSLog(@&quot;pre b =&gt; %d&quot;, b);</div><div class="line">    NSLog(@&quot;pre c =&gt; %d&quot;, c);</div><div class="line">    blockWithVar();</div><div class="line">    NSLog(@&quot;pre b =&gt; %d&quot;, b);</div><div class="line">    NSLog(@&quot;pre c =&gt; %d&quot;, c);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è½¬åŒ–å<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">int b = 3;</div><div class="line">static int c = 4;</div><div class="line"></div><div class="line">...</div><div class="line">static void __TestBlock__testStackBlock_block_func_0(struct __TestBlock__testStackBlock_block_impl_0 *__cself) &#123;</div><div class="line"></div><div class="line">        b = 5;</div><div class="line">        c = 6;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">static void _I_TestBlock_testStackBlock(TestBlock * self, SEL _cmd) &#123;</div><div class="line">    void(*blockWithVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_0((void *)__TestBlock__testStackBlock_block_func_0, &amp;__TestBlock__testStackBlock_block_desc_0_DATA));</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_d646c1_mi_0, b);</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_d646c1_mi_1, c);</div><div class="line">    ((void (*)(__block_impl *))((__block_impl *)blockWithVar)-&gt;FuncPtr)((__block_impl *)blockWithVar);</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_d646c1_mi_2, b);</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_d646c1_mi_3, c);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°å…¨å±€å˜é‡éƒ½æ˜¯ç›´æ¥è®¿é—®å˜é‡çš„ï¼Œæ˜¯å› ä¸ºå…¨å±€å˜é‡å­˜å‚¨åœ¨é™æ€æ•°æ®å­˜å‚¨åŒºï¼Œåœ¨ç¨‹åºç»“æŸå‰ä¸ä¼šè¢«é”€æ¯</p>
<p><strong>å®ä¾‹å˜é‡</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">@interface TestBlock ()</div><div class="line">&#123;</div><div class="line">    NSString *_str;</div><div class="line">    int _a;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">- (void)testStackBlock&#123;</div><div class="line">    void(^blockWithVar)(void) = ^&#123;</div><div class="line">        _a = 5;</div><div class="line">        _str = @&quot;test&quot;;</div><div class="line">    &#125;;</div><div class="line">    NSLog(@&quot;res a =&gt; %d&quot;, _a);</div><div class="line">    NSLog(@&quot;res str =&gt; %@&quot;, _str);</div><div class="line">    blockWithVar();</div><div class="line">    NSLog(@&quot;res a =&gt; %d&quot;, _a);</div><div class="line">    NSLog(@&quot;res str =&gt; %@&quot;, _str);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œç¼–è¯‘å™¨ä¼šç»™æˆ‘ä»¬è­¦å‘Šï¼Œæ„æ€å°±æ˜¯æœ‰éšå¼çš„<code>self</code>å¼•ç”¨ï¼Œæˆ‘ä»¬è½¬åŒ–ä¸€ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">struct __TestBlock__testStackBlock_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __TestBlock__testStackBlock_block_desc_0* Desc;</div><div class="line">  TestBlock *self;//TestBlock ç±»</div><div class="line">  __TestBlock__testStackBlock_block_impl_0(void *fp, struct __TestBlock__testStackBlock_block_desc_0 *desc, TestBlock *_self, int flags=0) : self(_self) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">static void __TestBlock__testStackBlock_block_func_0(struct __TestBlock__testStackBlock_block_impl_0 *__cself) &#123;</div><div class="line">  TestBlock *self = __cself-&gt;self; // bound by copy</div><div class="line">		// selfï¼‹å®ä¾‹å˜é‡açš„åç§»å€¼</div><div class="line">        (*(int *)((char *)self + OBJC_IVAR_$_TestBlock$_a)) = 5;</div><div class="line">        (*(NSString **)((char *)self + OBJC_IVAR_$_TestBlock$_str)) = (NSString *)&amp;__NSConstantStringImpl__var_folders_11__5wr7xmx2d944s1pgmnw7mn80000gn_T_TestBlock_0453bc_mi_0;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    static void __TestBlock__testStackBlock_block_copy_0(struct __TestBlock__testStackBlock_block_impl_0*dst, struct __TestBlock__testStackBlock_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;self, (void*)src-&gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line"></div><div class="line">static void __TestBlock__testStackBlock_block_dispose_0(struct __TestBlock__testStackBlock_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line"></div><div class="line">static struct __TestBlock__testStackBlock_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">  void (*copy)(struct __TestBlock__testStackBlock_block_impl_0*, struct __TestBlock__testStackBlock_block_impl_0*);</div><div class="line">  void (*dispose)(struct __TestBlock__testStackBlock_block_impl_0*);</div><div class="line">&#125; __TestBlock__testStackBlock_block_desc_0_DATA = &#123; 0, sizeof(struct __TestBlock__testStackBlock_block_impl_0), __TestBlock__testStackBlock_block_copy_0, __TestBlock__testStackBlock_block_dispose_0&#125;;</div><div class="line"></div><div class="line">static void _I_TestBlock_testStackBlock(TestBlock * self, SEL _cmd) &#123;</div><div class="line">//self ä¼ è¿›å»</div><div class="line">    void(*blockWithVar)(void) = ((void (*)())&amp;__TestBlock__testStackBlock_block_impl_0((void *)__TestBlock__testStackBlock_block_func_0, &amp;__TestBlock__testStackBlock_block_desc_0_DATA, self, 570425344));</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡ä¸Šé¢çœ‹åˆ°<code>block</code>å†…éƒ¨ä¼šç”Ÿæˆä¸€ä¸ª<code>TestBlock *self</code>ï¼Œå®ƒçš„å€¼ä¾¿æ˜¯<code>_I_TestBlock_testStackBlock</code>ä¸­çš„<code>self</code>æ‰€ä»¥å¯ä»¥æ›´æ”¹å®ä¾‹å˜é‡ï¼Œå½“ç„¶è¿™é‡Œä¼šæœ‰ä¸€ä¸ªå¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´<code>block</code>å¼•ç”¨å®ä¾‹å˜é‡ä¹Ÿä¼šå¼ºå¼•ç”¨<code>self</code></p>
<hr>
<p><strong>æ€»ç»“ï¼š</strong></p>
<ul>
<li><code>block</code>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŒ…å«è°ƒç”¨å‡½æ•°æŒ‡é’ˆã€blockå¤–éƒ¨ä¸Šä¸‹æ–‡å˜é‡çš„ç»“æ„ä½“</li>
<li><code>block</code>æœ‰æ ¹æ®å­˜å‚¨ä½ç½®ä¸åŒåˆ†ä¸ºä¸‰ç§ç±»å‹<ul>
<li>NSConcreteStackBlockï¼ˆæ ˆï¼‰NSConcreteGlobalBlockï¼ˆå…¨å±€ï¼‰NSConcreteMallocBlockï¼ˆå †ï¼‰</li>
</ul>
</li>
<li><code>ARC</code>æ¨¡å¼ä¸‹ä¼šæŠŠä¸å¼•ç”¨å¤–éƒ¨å˜é‡çš„<code>block</code>è½¬åŒ–æˆ<code>NSConcreteGlobalBlock</code>,å¼•ç”¨å¤–éƒ¨å˜é‡çš„<code>block</code>ä¼šåœ¨èµ‹å€¼æ—¶è½¬åŒ–ä¸º<code>NSConcreteMallocBlock</code></li>
<li><code>block</code>å¼•ç”¨å¤–éƒ¨å±€éƒ¨å˜é‡å’Œé™æ€å±€éƒ¨å˜é‡æˆ–å®ä¾‹å˜é‡æ—¶ä¼šåœ¨<code>block</code>å†…éƒ¨ç”Ÿæˆå¯¹åº”çš„å˜é‡ã€‚åœ¨å¼•ç”¨å…¨å±€å˜é‡æ—¶å¹¶ä¸ä¼šç”Ÿæˆå¯¹åº”å˜é‡ã€‚</li>
<li><code>Block</code>ä¼šå¯¹å†…éƒ¨çš„å˜é‡å½¢æˆå¼ºå¼•ç”¨ï¼Œè€Œå¦‚æœåŒæ—¶è¯¥å˜é‡åˆæŒæœ‰è¿™ä¸ª<code>Block</code>ï¼Œå°±ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨è€Œæ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚æ³¨æ„éšå¼çš„å¾ªç¯å¼•ç”¨</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ios/" rel="tag"># ios</a>
          
            <a href="/tags/block/" rel="tag"># block</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/23/ci/" rel="next" title="åŸºäºgitlabå’Œjenkinsæ­å»ºCI">
                <i class="fa fa-chevron-left"></i> åŸºäºgitlabå’Œjenkinsæ­å»ºCI
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/02/iosçŸ¥è¯†ç¢ç‰‡/" rel="prev" title="iosçŸ¥è¯†ç¢ç‰‡">
                iosçŸ¥è¯†ç¢ç‰‡ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">huanghe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#clangå·¥å…·"><span class="nav-number">1.</span> <span class="nav-text">clangå·¥å…·</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#block-ç»“æ„"><span class="nav-number">2.</span> <span class="nav-text">block ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockè°ƒç”¨"><span class="nav-number">3.</span> <span class="nav-text">blockè°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“"><span class="nav-number">4.</span> <span class="nav-text">blockç±»å‹ä»¥åŠARCå¯¹blockçš„å½±å“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“"><span class="nav-number">5.</span> <span class="nav-text">å¤–éƒ¨å˜é‡å¯¹blockçš„å½±å“</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">huanghe</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
